name: Deploy Backend to NCloud

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository (runner-local)
        uses: actions/checkout@v4

      - name: Prepare SSH key on runner
        shell: bash
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          cp ~/.ssh/id_deploy_rsa ~/.ssh/ncloud_rsa
          chmod 600 ~/.ssh/ncloud_rsa

      - name: Deploy on NCloud (.53) without heredoc
        shell: bash
        env:
          GIT_SSH_COMMAND: 'ssh -o StrictHostKeyChecking=no -i ~/.ssh/ncloud_rsa'
        run: |
          ssh -o ConnectTimeout=10 -i ~/.ssh/ncloud_rsa -o StrictHostKeyChecking=no irlab@223.130.137.53 '
            set -e
            cd ~/weup_backend
            git fetch origin
            git reset --hard origin/main
            sudo docker compose down || true
            sudo docker compose up --build -d
          '
